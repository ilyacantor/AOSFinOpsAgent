AOS Trifecta Flow
Agent Architecture Reference
AAM • Farm • DCL
v3 — Stable architecture reference. The pipeline is live.

Architecture Overview
The AOS data pipeline is a late-binding architecture. Three modules — AAM, Farm, and DCL — operate independently and converge at DCL via a shared join key: pipe_id. Each module is maintained by a separate coding agent that cannot see the other repos. This document provides each agent with the complete interface contracts it needs to operate correctly.

Critical principle: DCL performs a late-binding JOIN on pipe_id. Structure from Path 1 and Content from Path 3 must share the same pipe_id or the join produces nothing. This is the single most important contract in the system.
The Four Paths
Field
Description
Path 1 — Structure
AAM ? DCL. AAM exports pipe schemas via /export-pipes. DCL stores these as the schema blueprint for each pipe_id.
Path 2 — Instruction
AAM ? Farm. AAM dispatches JobManifest payloads to Farm's intake endpoint, telling Farm what to extract and where to deliver it.
Path 3 — Content
Farm ? DCL. Farm executes the manifest, extracts or generates data, and pushes rows to DCL's /ingest, tagged with the pipe_id from the manifest.
Path 4 — Verification
Farm ? DCL. Farm injects known ground truth data, reads it back from DCL, and compares. Farm is the test oracle.
Key Distinction: Dispatch vs. Target
• Dispatch routing (where AAM sends the manifest): AAM POSTs the JobManifest to Farm's intake endpoint, e.g. /api/farm/manifest-intake.
• Manifest target (where Farm delivers data): The manifest's target.dcl_url points to DCL's /ingest. This is an instruction inside the manifest — Farm reads it and knows where to push data.

Module: AAM
AAM is the architect. It draws blueprints (Path 1) and writes job orders (Path 2). It does not move data and does not execute extraction.

Path 1 — Structure Export (AAM ? DCL)
AAM publishes pipe schemas to DCL via /export-pipes. This tells DCL what pipes exist, what fields they carry, and how they're organized by fabric plane. This is metadata only — no data rows.

DCLExportResponse Schema
Field
Description
aod_run_id
string? — AOD discovery run identifier
timestamp
string — ISO 8601 with Z suffix
source
string — always 'aam'
total_connections
int
fabric_planes[]
List of DCLFabricPlane objects (see below)
DCLFabricPlane
Field
Description
plane_type
string
vendor
string
connection_count
int
health
string
connections[]
List of DCLConnectionSchema (see below)
DCLConnectionSchema
Field
Description
pipe_id
string — THE JOIN KEY. Must be DeclaredPipe.pipe_id (not candidate_id)
candidate_id
string — provenance tracking only
source_name
string
vendor
string
category
string
governance_status
string?
fields
list[string] — 5-level cascade
entity_scope
string? — from pipe inference
identity_keys
list? — from pipe inference
transport_kind
string? — from pipe inference
modality
string? — from pipe inference
change_semantics
string? — from pipe inference
health
string
last_sync
string?
asset_key
string
aod_asset_id
string?
Path 2 — Runner Manifest Dispatch (AAM ? Farm)
After building a JobManifest, AAM POSTs it to Farm's intake endpoint. AAM does not execute the manifest itself.

JobManifest Schema
Field
Description
manifest_version
string — '1.0'
run_id
string — generated by AAM, use as correlation key
farm_verification
bool — if true, Farm runs recon after push
source.pipe_id
string — MUST match the pipe_id in the Export
source.system
string — vendor name (salesforce, netsuite, etc.)
source.adapter
string — rest_api | jdbc | kafka | ipaas | webhook
source.endpoint_ref
dict — opaque connection info
source.credentials_ref
string? — vault URI, never plaintext
source.query
string? — extraction filter
transform.schema_map
dict — source_field ? {target, unit, scale, dim}
transform.grain
string? — quarter | month | day
transform.period_field
string?
transform.period_format
string? — YYYY-Qq, etc.
target.dcl_url
string — DCL's /ingest — tells Farm where to deliver
target.auth_token_ref
string?
target.tenant_id
string?
target.snapshot_name
string?
provenance.run_timestamp
string
provenance.triggered_by
string
limits.max_rows
int — default 100,000
limits.timeout_seconds
int — default 300
limits.retry_count
int — default 2
pipe_id contract: source.pipe_id in the JobManifest MUST be the same DeclaredPipe.pipe_id used in the Export's connections[].pipe_id. This is the join key. If they don't match, DCL cannot file Farm's data.
Module: Farm
Farm is the hauler. It receives job orders from AAM and delivers data to DCL. It is also the test oracle for the pipeline.

Path 2 — Manifest Intake
Farm exposes a POST endpoint (e.g. /api/farm/manifest-intake) that accepts a JobManifest, validates it, and queues it for execution. See JobManifest schema in the AAM section above.

Path 3 — DCL Push (Farm ? DCL)
Farm pushes extracted or generated data to DCL's /ingest, tagged with the pipe_id from the manifest.

Request Headers
Field
Description
x-run-id
string — from manifest.run_id
x-pipe-id
string — from manifest.source.pipe_id — THE JOIN KEY
x-schema-hash
string — computed from data schema
x-api-key
string
Request Body
Field
Description
source_system
string — from manifest.source.system
tenant_id
string — from manifest.target.tenant_id
snapshot_name
string — from manifest.target.snapshot_name
run_timestamp
string — from manifest.provenance.run_timestamp
schema_version
string — first 16 chars of schema_hash
row_count
int
rows
list[dict] — actual data rows
DCL Feedback Handling
Farm must act on DCL's response — not just capture it.

Success (HTTP 200)
Field
Description
dcl_run_id
string — DCL's internal run ID
pipe_id
string — echoed back for confirmation
rows_accepted
int
schema_drift
bool
drift_fields
list[string]? — only if drift detected
matched_schema
bool — confirms join succeeded
schema_fields
list[string] — what Export says this pipe has
timestamp
string
Rejection (HTTP 422 — NO_MATCHING_PIPE)
This means AAM's Structure Path and Farm's Content Path are misaligned. Do not retry — this is a configuration error. Log as CRITICAL with the pipe_id.
Field
Description
error
string — 'NO_MATCHING_PIPE'
pipe_id
string — what was sent
message
string
hint
string
available_pipes
list[string]? — known pipe_ids in DCL
timestamp
string
Required Behaviors on Feedback
• NO_MATCHING_PIPE (422): Log CRITICAL. Do not retry. Surface the pipe_id mismatch for operator review.
• schema_drift: Log WARNING with drift_fields. Continue processing but flag for review.
• Success with farm_verification=true: Trigger recon for this run_id.

Module: DCL
DCL is the smart warehouse and gatekeeper. It receives schema blueprints from AAM (Path 1) and data from Farm (Path 3), and unifies them via a late-binding join on pipe_id. NLQ queries DCL for answers.

If content arrives without a matching schema, DCL MUST reject it with a structured 422 error. Silent acceptance is the single worst failure mode in this architecture. A row accepted without a matching schema can never be queried by NLQ.
Ingest Guard Logic
Before accepting any ingest payload, DCL checks whether a pipe definition exists for the incoming pipe_id. If no match, return HTTP 422.

Field
Description
Check
lookup_pipe_definition(x-pipe-id header)
If null
Return 422 NO_MATCHING_PIPE with structured error (see Farm section)
If found
Proceed with schema drift detection and row acceptance
The Late-Binding Join
When NLQ queries for data, DCL joins:
• Structure (from Export): pipe_id ? fields, vendor, category, entity_scope, modality, transport_kind
• Content (from Ingest): pipe_id ? actual data rows

If pipe_ids don't match between Export and Ingest, the data is orphaned. The ingest guard prevents orphaned data from accumulating.

End-to-End Verification
After any change to AAM, Farm, or DCL, run this sequence to verify the full pipeline:

• Trigger AOD discovery to generate candidates
• AAM handoff: confirm candidates received and DeclaredPipes created
• AAM export: POST /export-pipes to DCL, confirm pipe schemas stored
• AAM dispatch: POST JobManifest to Farm /api/farm/manifest-intake
• Farm push: confirm Farm POSTs to DCL /ingest with correct x-pipe-id
• DCL confirmation: verify matched_schema: true in response
• Farm recon: verify ground truth data matches DCL output
• NLQ query: confirm NLQ can retrieve data for the ingested pipe

Correlation Key Map
These keys must be traceable across all four paths for end-to-end lineage:

Field
Description
pipe_id
THE canonical join key. Flows: AAM Export ? JobManifest ? Farm push headers ? DCL response
run_id
AAM-generated correlation key. Flows: JobManifest ? Farm push headers ? DCL dcl_run_id
aod_run_id
AOD discovery run. Flows: AOD ? AAM handoff ? AAM Export response
snapshot_name
Human-readable label. Flows: AAM ? JobManifest target ? Farm push body
AOS Trifecta Flow v3 — Stable Architecture Reference — February 2026
